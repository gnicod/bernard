

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Number Bot &mdash; bernard  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> bernard
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">bernard</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Number Bot</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/get-started/number-bot.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="number-bot">
<span id="number-bot"></span><h1>Number Bot<a class="headerlink" href="#number-bot" title="Permalink to this headline">¶</a></h1>
<p>As an exercise, we’re going to create a simple bot that will ask you
to guess a number between 1 and 100. When you guess it, you can play
again!</p>
<p>It’s a good exercise to get to know the main features of BERNARD.</p>
<p>Please note that this bot uses Facebook-specific features and is not
compatible out-of-the-box with other platforms.</p>
<div class="section" id="conception">
<span id="conception"></span><h2>Conception<a class="headerlink" href="#conception" title="Permalink to this headline">¶</a></h2>
<p>A typical conversation would be:</p>
<ul class="simple">
<li><strong>Bot</strong>: Welcome! Do you want to play?</li>
<li><strong>User</strong>: Let’s play <em>(quick reply)</em></li>
<li><strong>Bot</strong>: Guess a number between 1 and 100</li>
<li><strong>User</strong>: 50</li>
<li><strong>Bot</strong>: Nope, lower</li>
<li><strong>User</strong>: 42</li>
<li><strong>Bot</strong>: Great! Do you want to play again?</li>
</ul>
<p>This gives the following flow:</p>
<p><img alt="number bot" src="../_images/number-bot.svg" /></p>
</div>
<div class="section" id="starting-the-project">
<span id="starting-the-project"></span><h2>Starting the project<a class="headerlink" href="#starting-the-project" title="Permalink to this headline">¶</a></h2>
<p>Let’s start the project!</p>
<div class="section" id="create-the-code">
<span id="create-the-code"></span><h3>Create the code<a class="headerlink" href="#create-the-code" title="Permalink to this headline">¶</a></h3>
<p>First, create the code skeleton. You need to have followed the
<a class="reference external" href="./installation.md">installation</a> instructions.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bernard start_project number_bot ~/dev/number_bot
</pre></div>
</div>
<p>Of course you can adjust <code class="docutils literal notranslate"><span class="pre">~/dev/number_bot</span></code> to the location where you
want to put your project.</p>
</div>
<div class="section" id="get-a-https-url">
<span id="get-a-https-url"></span><h3>Get a HTTPS URL<a class="headerlink" href="#get-a-https-url" title="Permalink to this headline">¶</a></h3>
<p>You will need a <strong>public HTTPS URL</strong> for your bot to work. If you don’t
have one, you can try using <a class="reference external" href="https://ngrok.com/"><code class="docutils literal notranslate"><span class="pre">ngrok</span></code></a> for this
purpose.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ngrok http <span class="m">8666</span>
</pre></div>
</div>
<p>If you have another way to have this, please do so. In any case, you
need to note down this URL. From here on, we’ll refer this as
<code class="docutils literal notranslate"><span class="pre">https://YOUR.DOMAIN.COM</span></code>.</p>
</div>
<div class="section" id="configure-facebook">
<span id="configure-facebook"></span><h3>Configure Facebook<a class="headerlink" href="#configure-facebook" title="Permalink to this headline">¶</a></h3>
<p>Then, you need to get Facebook tokens and IDs. In order to do so, you
need to:</p>
<ol class="simple">
<li><a class="reference external" href="https://www.facebook.com/pages/create/">Create a Facebook page</a></li>
<li>Copy the page ID (that’s the big ID in the URL)</li>
<li><a class="reference external" href="https://developers.facebook.com/">Create a Facebook app</a></li>
<li>Copy the app ID and app secret (they are available in the app’s
basic settings)</li>
<li>Go to the “Messenger/Settings” part of your app’s admin and generate
the token for the page you created.</li>
</ol>
</div>
<div class="section" id="create-your-env-file">
<span id="create-your-env-file"></span><h3>Create your <code class="docutils literal notranslate"><span class="pre">env</span></code> file<a class="headerlink" href="#create-your-env-file" title="Permalink to this headline">¶</a></h3>
<p>By default, the configuration is read from environment variables. Let’s
create a <code class="docutils literal notranslate"><span class="pre">env</span></code> file with the following content:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> -a

<span class="nv">DEBUG</span><span class="o">=</span>yes

<span class="nv">BERNARD_SETTINGS_FILE</span><span class="o">=</span>/PATH/TO/YOUR/SETTINGS/FILE.py
<span class="nv">BERNARD_BASE_URL</span><span class="o">=</span>https://YOUR.DOMAIN.COM
<span class="nv">WEBVIEW_SECRET_KEY</span><span class="o">=</span>A_SECRET_KEY

<span class="nv">FB_APP_ID</span><span class="o">=</span>XXXX
<span class="nv">FB_APP_SECRET</span><span class="o">=</span>XXXX
<span class="nv">FB_PAGE_ID</span><span class="o">=</span>XXXX
<span class="nv">FB_PAGE_TOKEN</span><span class="o">=</span>XXXX
<span class="nv">FB_SECURITY_TOKEN</span><span class="o">=</span>SOME_ARBITRARY_VALUE
</pre></div>
</div>
<p>Don’t forget to replace the values with the approriate values in your
case (the public HTTPS URL, the Facebook IDs, etc). By default, the
<code class="docutils literal notranslate"><span class="pre">create_project</span></code> command has created the <code class="docutils literal notranslate"><span class="pre">env</span></code> file with consistent
values, so you can just focus on the <code class="docutils literal notranslate"><span class="pre">FB_*</span></code> values.</p>
<p>Please note that you can put any arbitrary value in <code class="docutils literal notranslate"><span class="pre">FB_SECURITY_TOKEN</span></code>,
it just need to be a unique and secure string.</p>
<p>Once the file is complete, you can source it then start the bot.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> ./env
./manage.py run
</pre></div>
</div>
<p>And then connect your bot to Facebook. You need to go back to your app’s
settings in Facebook developers, in the “Messenger/Settings” section,
and then subscribe to the webhook.</p>
<p>You need to put the following values:</p>
<ul class="simple">
<li><strong>Callback URL</strong>: <code class="docutils literal notranslate"><span class="pre">https://YOUR.DOMAIN.COM/hooks/facebook</span></code></li>
<li><strong>Verify Token</strong>: The value that you put in <code class="docutils literal notranslate"><span class="pre">FB_SECURITY_TOKEN</span></code></li>
<li><strong>Subscribed events</strong>: <code class="docutils literal notranslate"><span class="pre">messages</span></code>, <code class="docutils literal notranslate"><span class="pre">messaging_postbacks</span></code>,
<code class="docutils literal notranslate"><span class="pre">messaging_optins</span></code></li>
</ul>
<p>Once the webhook is validated, still in the “Webhook” section of the
Messenger settings, you can subscribe the app to the page you created.</p>
<p>At this point, you should be able to talk to your bot by going to
<code class="docutils literal notranslate"><span class="pre">http://m.me/FB_PAGE_ID</span></code> (please replace <code class="docutils literal notranslate"><span class="pre">FB_PAGE_ID</span></code> by the actual ID).</p>
</div>
</div>
<div class="section" id="creating-the-states">
<span id="creating-the-states"></span><h2>Creating the states<a class="headerlink" href="#creating-the-states" title="Permalink to this headline">¶</a></h2>
<p>We’ll use the <code class="docutils literal notranslate"><span class="pre">states.py</span></code> file to create all four states that we
designed earlier.</p>
<p>First, make sure to have the following imports:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SystemRandom</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">bernard</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">layers</span> <span class="k">as</span> <span class="n">lyr</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bernard.analytics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">page_view</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bernard.engine</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseState</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bernard.i18n</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">intents</span> <span class="k">as</span> <span class="n">its</span><span class="p">,</span>
    <span class="n">translate</span> <span class="k">as</span> <span class="n">t</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bernard.platforms.facebook</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">layers</span> <span class="k">as</span> <span class="n">fbl</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.store</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cs</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">random</span> <span class="o">=</span> <span class="n">SystemRandom</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="welcome">
<span id="welcome"></span><h3>1. Welcome<a class="headerlink" href="#welcome" title="Permalink to this headline">¶</a></h3>
<p>The welcome state is fairly simple, since it just unconditionnally sends
a message.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">S001xWelcome</span><span class="p">(</span><span class="n">NumberBotState</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Welcome the user</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@page_view</span><span class="p">(</span><span class="s1">&#39;/bot/welcome&#39;</span><span class="p">)</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_friendly_name</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="n">lyr</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;WELCOME&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)),</span>
            <span class="n">fbl</span><span class="o">.</span><span class="n">QuickRepliesList</span><span class="p">([</span>
                <span class="n">fbl</span><span class="o">.</span><span class="n">QuickRepliesList</span><span class="o">.</span><span class="n">TextOption</span><span class="p">(</span>
                    <span class="n">slug</span><span class="o">=</span><span class="s1">&#39;play&#39;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">LETS_PLAY</span><span class="p">,</span>
                    <span class="n">intent</span><span class="o">=</span><span class="n">its</span><span class="o">.</span><span class="n">LETS_PLAY</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>Let’s break this down.</p>
<p>First of all, the class <code class="docutils literal notranslate"><span class="pre">S001xWelcome</span></code> is named in order to have its
reference number. That’s just a convention which has no technical
impact, but is quite helpful as the project grows. Let’s also note that
it inherits from <code class="docutils literal notranslate"><span class="pre">NumberBotState</span></code>. That’s a way to inherit the <code class="docutils literal notranslate"><span class="pre">error()</span></code>
and <code class="docutils literal notranslate"><span class="pre">confused()</span></code> functions. You can override them on a per-state basis
if you want to customize error messages.</p>
<p>Each state implements a <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span> <span class="pre">handle(self)</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code> function. All
the action happens there. When the FSM enters a state, this <code class="docutils literal notranslate"><span class="pre">handle()</span></code>
function is called. During the handling, you can call <code class="docutils literal notranslate"><span class="pre">self.send()</span></code> as
many times as you want to. The messages are not sent immediately, but
rather stacked up and sent after the handling function returns.</p>
<p>There is a <code class="docutils literal notranslate"><span class="pre">&#64;page_view()</span></code> decorator. This is used for analytics tracking
in case where the analytics tracked is configured (which is not the
case here).</p>
<p>A single call to <code class="docutils literal notranslate"><span class="pre">self.send()</span></code> generates exactly one message (unless
some special cases or mingling by a middleware). All the arguments given
to <code class="docutils literal notranslate"><span class="pre">self.send()</span></code> are layers. The order of layers matters!</p>
<div class="section" id="layers">
<span id="layers"></span><h4>Layers<a class="headerlink" href="#layers" title="Permalink to this headline">¶</a></h4>
<p>We have two layers in this message:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">lyr.Text(t.WELCOME)</span></code> is a text layer, whose text is the <code class="docutils literal notranslate"><span class="pre">WELCOME</span></code>
string that you can find in <code class="docutils literal notranslate"><span class="pre">responses.csv</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">fbl.QuickRepliesList()</span></code> is a list of quick replies that will be
suggested to the user after the message itself</li>
</ul>
</div>
<div class="section" id="translations">
<span id="translations"></span><h4>Translations<a class="headerlink" href="#translations" title="Permalink to this headline">¶</a></h4>
<p>The translation system works the following way. First, there is the
imports:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bernard.i18n</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">intents</span> <span class="k">as</span> <span class="n">its</span><span class="p">,</span>
    <span class="n">translate</span> <span class="k">as</span> <span class="n">t</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>There is two things here: the intents (<code class="docutils literal notranslate"><span class="pre">its</span></code>) and the translations
(<code class="docutils literal notranslate"><span class="pre">t</span></code>). They come respectively from <code class="docutils literal notranslate"><span class="pre">intents.csv</span></code> and <code class="docutils literal notranslate"><span class="pre">responses.csv</span></code>.</p>
<p>Here are the two ways to use the translations:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">t.LETS_PLAY</span></code> will return a simple translation</li>
<li><code class="docutils literal notranslate"><span class="pre">t('WELCOME',</span> <span class="pre">name=name)</span></code> will return a parametrized translation</li>
</ul>
<p>Please note that returned values are not strings (nor “lazy” strings)
but rather translation objects that will be rendered when sending the
messages.</p>
<p>If a translation appears several times in the <code class="docutils literal notranslate"><span class="pre">responses.csv</span></code> file, the
output will be randomized.</p>
<p>On the other hand, there is intents. Intents are a set of sentences
that the user can say in order to trigger a specific action. In the
current case, the quick reply will display “Let’s play” but if the user
decides to type “yes” or “let’s go” then the choice will happen as well.
Intents are of the form <code class="docutils literal notranslate"><span class="pre">its.LETS_PLAY</span></code>.</p>
</div>
<div class="section" id="quick-replies">
<span id="quick-replies"></span><h4>Quick replies<a class="headerlink" href="#quick-replies" title="Permalink to this headline">¶</a></h4>
<p>To get a sense of how quick replies work, please refer yourself to
<a class="reference external" href="https://developers.facebook.com/docs/messenger-platform/send-messages/quick-replies">Facebook’s documentation</a>.</p>
<p>The layer <code class="docutils literal notranslate"><span class="pre">QuickRepliesList</span></code> is Facebook-specific, so you find it in the
<code class="docutils literal notranslate"><span class="pre">fbl</span></code> namespace instead of <code class="docutils literal notranslate"><span class="pre">lyr</span></code>.</p>
<p>It takes as argument a list of quick reply options. Here we have only
one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fbl</span><span class="o">.</span><span class="n">QuickRepliesList</span><span class="o">.</span><span class="n">TextOption</span><span class="p">(</span>
    <span class="n">slug</span><span class="o">=</span><span class="s1">&#39;play&#39;</span><span class="p">,</span>
    <span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">LETS_PLAY</span><span class="p">,</span>
    <span class="n">intent</span><span class="o">=</span><span class="n">its</span><span class="o">.</span><span class="n">LETS_PLAY</span><span class="p">,</span>
<span class="p">),</span>
</pre></div>
</div>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">slug</span></code> parameter is for internal use. It matches what you can see
in the flow diagram and will be used in transitions later.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">text</span></code> is what will be displayed to the user</li>
<li>The <code class="docutils literal notranslate"><span class="pre">intent</span></code> parameter is what the user can say to trigger this option
without clicking it</li>
</ul>
</div>
<div class="section" id="getting-the-name">
<span id="getting-the-name"></span><h4>Getting the name<a class="headerlink" href="#getting-the-name" title="Permalink to this headline">¶</a></h4>
<p>We also get the user’s name to put in the translation. It’s like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_friendly_name</span><span class="p">()</span>
</pre></div>
</div>
<p>It’s simply a way to make a call to the platform’s API and get the
user’s name. As the name of the user is a pretty vague notion, there is
a <code class="docutils literal notranslate"><span class="pre">get_friendly_name()</span></code> function which sorts out the most consistent
way to talk friendly to the user. It’s usually the first name, but not
necessarily.</p>
</div>
<div class="section" id="wrap-up">
<span id="wrap-up"></span><h4>Wrap-up<a class="headerlink" href="#wrap-up" title="Permalink to this headline">¶</a></h4>
<p>Basically, this is quite representative of a typical state. First we
gather data to display, then we create a message and send it.</p>
</div>
</div>
<div class="section" id="guess-a-number">
<span id="guess-a-number"></span><h3>2. Guess A Number<a class="headerlink" href="#guess-a-number" title="Permalink to this headline">¶</a></h3>
<p>That’s the first state of a gaming session. The goal is to draw the
number to guess and then to tell the user to guess it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">S002xGuessANumber</span><span class="p">(</span><span class="n">NumberBotState</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the number to guess behind the scenes and tell the user to guess it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># noinspection PyMethodOverriding</span>
    <span class="nd">@page_view</span><span class="p">(</span><span class="s1">&#39;/bot/guess-a-number&#39;</span><span class="p">)</span>
    <span class="nd">@cs.inject</span><span class="p">()</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GUESS_A_NUMBER</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="context">
<span id="context"></span><h4>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h4>
<p>We’ll store the number in the context.</p>
<p><strong>PLEASE NOTE</strong> that the context is volatile. We’re only be using the
context here because it’s convenient for the demo. However, if you want
truely persistant data, you need to build an API that will store user
data for you.</p>
<p>Now, let’s create a <code class="docutils literal notranslate"><span class="pre">store.py</span></code> file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">bernard.storage.context</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_context_store</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">cs</span> <span class="o">=</span> <span class="n">create_context_store</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>This creates a context store. You can create as many context stores as
you want, as long as you set a different name for each of them. By
default, store keys expire after 20 minutes. However, in this case we
want to keep data forever. That is why we set <code class="docutils literal notranslate"><span class="pre">ttl=0</span></code> to have an
infinite expiration time.</p>
<p>A store can inject a context into a handler or a trigger.</p>
<p>That’s what happens here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@cs.inject</span><span class="p">()</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>You just need to add a <code class="docutils literal notranslate"><span class="pre">context</span></code> argument to <code class="docutils literal notranslate"><span class="pre">handle()</span></code>. The context
is simply a dictionary object that will be persisted after you exit
the state. This allows to define the number:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sending-a-message">
<span id="sending-a-message"></span><h4>Sending a message<a class="headerlink" href="#sending-a-message" title="Permalink to this headline">¶</a></h4>
<p>You should be able to understand message sending:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">GUESS_A_NUMBER</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="guess-again">
<span id="guess-again"></span><h3>3. Guess Again<a class="headerlink" href="#guess-again" title="Permalink to this headline">¶</a></h3>
<p>That’s where we go when the user gave a wrong answer. We’ll see later
how to create the trigger that decides if the user is right or wrong,
but for now let’s just consider that it has a <code class="docutils literal notranslate"><span class="pre">user_number</span></code> attribute
which is the parsed number.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">S003xGuessAgain</span><span class="p">(</span><span class="n">NumberBotState</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the user gave a number that is wrong, we give an indication whether that</span>
<span class="sd">    guess is too low or too high.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># noinspection PyMethodOverriding</span>
    <span class="nd">@page_view</span><span class="p">(</span><span class="s1">&#39;/bot/guess-again&#39;</span><span class="p">)</span>
    <span class="nd">@cs.inject</span><span class="p">()</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">user_number</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">WRONG</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">user_number</span> <span class="o">&lt;</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">HIGHER</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">LOWER</span><span class="p">))</span>
</pre></div>
</div>
<p>You should be able to understand most of what happens here. The only
specific thing is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">user_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">user_number</span>
</pre></div>
</div>
<p>Which is how we access the past trigger.</p>
</div>
<div class="section" id="congrats">
<span id="congrats"></span><h3>4. Congrats<a class="headerlink" href="#congrats" title="Permalink to this headline">¶</a></h3>
<p>The congrats state is practicaly the same as the welcome one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">S004xCongrats</span><span class="p">(</span><span class="n">NumberBotState</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Congratulate the user for finding the number and propose to find another</span>
<span class="sd">    one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@page_view</span><span class="p">(</span><span class="s1">&#39;/bot/congrats&#39;</span><span class="p">)</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="n">lyr</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">CONGRATULATIONS</span><span class="p">),</span>
            <span class="n">fbl</span><span class="o">.</span><span class="n">QuickRepliesList</span><span class="p">([</span>
                <span class="n">fbl</span><span class="o">.</span><span class="n">QuickRepliesList</span><span class="o">.</span><span class="n">TextOption</span><span class="p">(</span>
                    <span class="n">slug</span><span class="o">=</span><span class="s1">&#39;again&#39;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">PLAY_AGAIN</span><span class="p">,</span>
                    <span class="n">intent</span><span class="o">=</span><span class="n">its</span><span class="o">.</span><span class="n">PLAY_AGAIN</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-the-trigger">
<span id="writing-the-trigger"></span><h2>Writing the trigger<a class="headerlink" href="#writing-the-trigger" title="Permalink to this headline">¶</a></h2>
<p>BERNARD comes with a handful of triggers, however you have the freedom
to create your own triggers in order to fit your needs. In the current
case, we need to create a specific trigger to know if the answer was
right or wrong. And also, as you have seen in <code class="docutils literal notranslate"><span class="pre">S003xGuessAgain</span></code>, provide
the state with the parsed number.</p>
<p>Create a <code class="docutils literal notranslate"><span class="pre">trigger.py</span></code> file with the following content:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bernard</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">layers</span> <span class="k">as</span> <span class="n">lyr</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bernard.engine.triggers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseTrigger</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.store</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cs</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">Number</span><span class="p">(</span><span class="n">BaseTrigger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This trigger will try to interpret what the user sends as a number. If it</span>
<span class="sd">    is a number, then it&#39;s compared to the number to guess in the context.</span>
<span class="sd">    The `is_right` parameter allows to say if you want the trigger to activate</span>
<span class="sd">    when the guess is right or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">is_right</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_right</span> <span class="o">=</span> <span class="n">is_right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_number</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># noinspection PyMethodOverriding</span>
    <span class="nd">@cs.inject</span><span class="p">()</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">number</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">.</span><span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">RawText</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">.</span><span class="mi">0</span>

        <span class="n">is_right</span> <span class="o">=</span> <span class="n">number</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_number</span>

        <span class="k">return</span> <span class="mf">1.</span> <span class="k">if</span> <span class="n">is_right</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_right</span> <span class="k">else</span> <span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
<p>All triggers must inherit from <code class="docutils literal notranslate"><span class="pre">BaseTrigger</span></code>, take <code class="docutils literal notranslate"><span class="pre">request</span></code> as
first argument of the constructor and implement a <code class="docutils literal notranslate"><span class="pre">rank()</span></code> function.
Other than that you’re free to do whatever you want.</p>
<p>Most of the code is straightforward Python. There is just a specific
linke that requires explanations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">RawText</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</pre></div>
</div>
<p>This is a way to retrieve a <code class="docutils literal notranslate"><span class="pre">RawText</span></code> layer from the incoming message.
Since this type of layer defines a <code class="docutils literal notranslate"><span class="pre">text</span></code> property, we can then simply
get its content by doing <code class="docutils literal notranslate"><span class="pre">.text</span></code> on it.</p>
<p>Please note the <code class="docutils literal notranslate"><span class="pre">except</span></code> that will catch <code class="docutils literal notranslate"><span class="pre">KeyError</span></code>. That’s because if
this layer type cannot be found a <code class="docutils literal notranslate"><span class="pre">KeyError</span></code> will raise.</p>
<p>In the end, we return a float between 0 and 1. The closest we are to 1
and the most sure we are that the message is for us. In this case, we
know for sure if the user gave a number or not.</p>
<p>There is also the <code class="docutils literal notranslate"><span class="pre">is_right</span></code> property, defined from the constructor.
Depending on its value, the output of <code class="docutils literal notranslate"><span class="pre">rank()</span></code> will be <code class="docutils literal notranslate"><span class="pre">1.0</span></code> when the
user guessed correctly or when they missed.</p>
<div class="section" id="connecting-the-triggers">
<span id="connecting-the-triggers"></span><h3>Connecting the triggers<a class="headerlink" href="#connecting-the-triggers" title="Permalink to this headline">¶</a></h3>
<p>The last file to touch is <code class="docutils literal notranslate"><span class="pre">transitions.py</span></code>. Basically, it’s all the
arrows we see in the flow graph.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>

<span class="kn">from</span> <span class="nn">bernard.engine</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Tr</span><span class="p">,</span>
    <span class="n">triggers</span> <span class="k">as</span> <span class="n">trg</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bernard.i18n</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">intents</span> <span class="k">as</span> <span class="n">its</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.states</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.triggers</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Tr</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">S001xWelcome</span><span class="p">,</span>
        <span class="n">factory</span><span class="o">=</span><span class="n">trg</span><span class="o">.</span><span class="n">Action</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="s1">&#39;get_started&#39;</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">Tr</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">S002xGuessANumber</span><span class="p">,</span>
        <span class="n">factory</span><span class="o">=</span><span class="n">trg</span><span class="o">.</span><span class="n">Action</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="s1">&#39;guess&#39;</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">Tr</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">S002xGuessANumber</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="n">S001xWelcome</span><span class="p">,</span>
        <span class="n">factory</span><span class="o">=</span><span class="n">trg</span><span class="o">.</span><span class="n">Choice</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="s1">&#39;play&#39;</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">Tr</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">S003xGuessAgain</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="n">S002xGuessANumber</span><span class="p">,</span>
        <span class="n">factory</span><span class="o">=</span><span class="n">Number</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="n">is_right</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">Tr</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">S003xGuessAgain</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="n">S003xGuessAgain</span><span class="p">,</span>
        <span class="n">factory</span><span class="o">=</span><span class="n">Number</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="n">is_right</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">Tr</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">S004xCongrats</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="n">S003xGuessAgain</span><span class="p">,</span>
        <span class="n">factory</span><span class="o">=</span><span class="n">Number</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="n">is_right</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">Tr</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">S004xCongrats</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="n">S002xGuessANumber</span><span class="p">,</span>
        <span class="n">factory</span><span class="o">=</span><span class="n">Number</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="n">is_right</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">Tr</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">S002xGuessANumber</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="n">S004xCongrats</span><span class="p">,</span>
        <span class="n">factory</span><span class="o">=</span><span class="n">trg</span><span class="o">.</span><span class="n">Choice</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="s1">&#39;again&#39;</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>As you can see here, for each arrow we create a <code class="docutils literal notranslate"><span class="pre">Tr</span></code> object. The
arguments we see are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">dest</span></code> is the destination state</li>
<li><code class="docutils literal notranslate"><span class="pre">origin</span></code> is the source state. If it’s not specified, any source can
be valid</li>
<li><code class="docutils literal notranslate"><span class="pre">factory</span></code> is the factory of the trigger for this transition</li>
</ul>
<p>Each trigger has a <code class="docutils literal notranslate"><span class="pre">builder()</span></code> class method. It will create the factory
for this trigger. You can specify the exact same arguments than those
accepted by <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> except the <code class="docutils literal notranslate"><span class="pre">request</span></code>.</p>
<p>We see here 3 types of triggers:</p>
<div class="section" id="action">
<span id="action"></span><h4>Action<a class="headerlink" href="#action" title="Permalink to this headline">¶</a></h4>
<p>The action trigger expects a <code class="docutils literal notranslate"><span class="pre">Postback</span></code> message, aka what happens when
the user clicks on a button or in the menu. The content of those
<code class="docutils literal notranslate"><span class="pre">Postback</span></code> messages is a JSON payload that is configured when you send
the button to the user or in the <code class="docutils literal notranslate"><span class="pre">settings.py</span></code> file where you setup the
menu.</p>
<p>As per the flow, we have two distinctive actions which are
<code class="docutils literal notranslate"><span class="pre">get_started</span></code> (the default action behind Facebook’s “Get Started”
button) and <code class="docutils literal notranslate"><span class="pre">guess</span></code> which is in the menu.</p>
<p>Usually, <code class="docutils literal notranslate"><span class="pre">Action</span></code> triggers don’t have an <code class="docutils literal notranslate"><span class="pre">origin</span></code> since they are
indicate a pretty strong and unequivocal will from the user to
interrupt the current flow.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tr</span><span class="p">(</span>
    <span class="n">dest</span><span class="o">=</span><span class="n">S001xWelcome</span><span class="p">,</span>
    <span class="n">factory</span><span class="o">=</span><span class="n">trg</span><span class="o">.</span><span class="n">Action</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="s1">&#39;get_started&#39;</span><span class="p">),</span>
<span class="p">),</span>
</pre></div>
</div>
</div>
<div class="section" id="choice">
<span id="choice"></span><h4>Choice<a class="headerlink" href="#choice" title="Permalink to this headline">¶</a></h4>
<p>Quick replies clicks can be catched by the <code class="docutils literal notranslate"><span class="pre">Choice</span></code> trigger. It will
detect if the user makes any of the available choices. The argument
given is the <code class="docutils literal notranslate"><span class="pre">slug</span></code> that we specified earlier when creating the quick
replies list in the state.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tr</span><span class="p">(</span>
    <span class="n">dest</span><span class="o">=</span><span class="n">S002xGuessANumber</span><span class="p">,</span>
    <span class="n">origin</span><span class="o">=</span><span class="n">S001xWelcome</span><span class="p">,</span>
    <span class="n">factory</span><span class="o">=</span><span class="n">trg</span><span class="o">.</span><span class="n">Choice</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="s1">&#39;play&#39;</span><span class="p">),</span>
<span class="p">),</span>
</pre></div>
</div>
</div>
<div class="section" id="number">
<span id="number"></span><h4>Number<a class="headerlink" href="#number" title="Permalink to this headline">¶</a></h4>
<p>This is the trigger that we created earlier. Please note that we make
the <code class="docutils literal notranslate"><span class="pre">is_right</span></code> argument vary to fit the condition of each arrow.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tr</span><span class="p">(</span>
    <span class="n">dest</span><span class="o">=</span><span class="n">S004xCongrats</span><span class="p">,</span>
    <span class="n">origin</span><span class="o">=</span><span class="n">S002xGuessANumber</span><span class="p">,</span>
    <span class="n">factory</span><span class="o">=</span><span class="n">Number</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="n">is_right</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
<span class="p">),</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="settings">
<span id="settings"></span><h2>Settings<a class="headerlink" href="#settings" title="Permalink to this headline">¶</a></h2>
<p>Once all of this is set, you just need to configure Facebook in the
settings and then you’ll be all set.</p>
<p>The default settings are fine, you just need to set the content of
<code class="docutils literal notranslate"><span class="pre">PLATFORMS</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PLATFORMS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;bernard.platforms.facebook.platform.Facebook&#39;</span><span class="p">,</span>
        <span class="s1">&#39;settings&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;security_token&#39;</span><span class="p">:</span> <span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FB_SECURITY_TOKEN&#39;</span><span class="p">),</span>
                <span class="s1">&#39;app_id&#39;</span><span class="p">:</span> <span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FB_APP_ID&#39;</span><span class="p">),</span>
                <span class="s1">&#39;app_secret&#39;</span><span class="p">:</span> <span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FB_APP_SECRET&#39;</span><span class="p">),</span>
                <span class="s1">&#39;page_id&#39;</span><span class="p">:</span> <span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FB_PAGE_ID&#39;</span><span class="p">),</span>
                <span class="s1">&#39;page_token&#39;</span><span class="p">:</span> <span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FB_PAGE_TOKEN&#39;</span><span class="p">),</span>
                <span class="s1">&#39;greeting&#39;</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s1">&#39;locale&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Welcome to the number bot!&#39;</span><span class="p">,</span>
                <span class="p">}],</span>
                <span class="s1">&#39;menu&#39;</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s1">&#39;locale&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;call_to_actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Guess a number&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;postback&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="s1">&#39;{&quot;action&quot;: &quot;guess&quot;}&#39;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">]</span>
                <span class="p">}],</span>
                <span class="s1">&#39;whitelist&#39;</span><span class="p">:</span> <span class="n">make_whitelist</span><span class="p">()</span>
            <span class="p">},</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>To understand the content of <code class="docutils literal notranslate"><span class="pre">greeting</span></code> and <code class="docutils literal notranslate"><span class="pre">menu</span></code>, please refer
yourself to the documentation of the
<a class="reference external" href="https://developers.facebook.com/docs/messenger-platform/reference/messenger-profile-api/greeting">greeting message</a>
and the
<a class="reference external" href="https://developers.facebook.com/docs/messenger-platform/reference/messenger-profile-api/persistent-menu">persistent menu</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">whitelist</span></code> is a list of domains allowed to use the messenger
extensions. If you extend this bot, you need to keep it up-to-date with
all the domains you use by editing the <code class="docutils literal notranslate"><span class="pre">make_whitelist()</span></code> function.
However for this bot, you don’t need to touch it.</p>
</div>
<div class="section" id="testing-the-bot">
<span id="testing-the-bot"></span><h2>Testing the bot<a class="headerlink" href="#testing-the-bot" title="Permalink to this headline">¶</a></h2>
<p>Now the bot is complete! It’s time for you to test the bot. If something
seems to be wrong, you can consult the reference source code
<a class="reference external" href="../../examples/number_bot">in this repository</a>.</p>
</div>
<div class="section" id="wrap-up">
<span id="id1"></span><h2>Wrap up<a class="headerlink" href="#wrap-up" title="Permalink to this headline">¶</a></h2>
<p>That was a long chapter!</p>
<p>We’ve created a simple demo bot which is a number-guessing game. There
is two main parts to this bot: the states on one hand that describe
what the bot should send and the transitions on the other hand that
describe how to react to the user’s input.</p>
<p><strong>Next step</strong>: <a class="reference external" href="./patterns.md">patterns</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Remy Sanchez.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>